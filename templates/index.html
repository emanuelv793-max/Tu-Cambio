<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Conversor de Monedas</title>
  <link rel="manifest" href="/static/manifest.webmanifest">
  <meta name="theme-color" content="#2563eb" />
  <link rel="apple-touch-icon" href="/static/icon-192.png" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <style>
    :root {
      --bg: #f6f8fb;
      --panel: #ffffff;
      --text: #1e293b;
      --muted: #64748b;
      --brand: #2563eb;
      --brand-600: #1d4ed8;
      --ok-bg: #e0f2fe;
      --ok-border: #bae6fd;
      --err-bg: #fef2f2;
      --err-border: #fecaca;
      --shadow: 0 6px 24px rgba(2, 6, 23, 0.08);
    }
    [data-theme="dark"] {
      --bg: #0b1220;
      --panel: #0f172a;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --brand: #60a5fa;
      --brand-600: #3b82f6;
      --ok-bg: #082f49;
      --ok-border: #0e7490;
      --err-bg: #3f1d1d;
      --err-border: #7f1d1d;
      --shadow: 0 8px 28px rgba(2, 6, 23, 0.55);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      background-image: url('https://tse1.mm.bing.net/th/id/OIP.I8yfqQYuyKi6q4pkfVP-IQHaEr?rs=1&pid=ImgDetMain&o=7&rm=3');
      background-repeat: no-repeat;
      background-position: center center;
      background-attachment: fixed;
      background-size: cover;
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 28px 14px;
    }

    .card {
      width: 100%;
      max-width: 560px;
      background: var(--panel);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 22px 22px 16px;
    }

    .card-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 12px; }
    .title { margin: 0; font-size: 1.25rem; font-weight: 700; letter-spacing: .2px; }

    .actions { display: flex; gap: 8px; align-items: center; }
    .btn {
      appearance: none; border: 0; border-radius: 10px; padding: 10px 14px; cursor: pointer;
      background: var(--brand); color: white; font-weight: 600; box-shadow: 0 1px 0 rgba(0,0,0,.06);
      transition: transform .04s ease, background .2s ease;
    }
    .btn:hover { background: var(--brand-600); }
    .btn:active { transform: translateY(1px); }

    .btn-outline {
      background: transparent; color: var(--brand); border: 2px solid var(--brand);
    }

    .grid { display: grid; grid-template-columns: 1fr; gap: 14px; }
    @media (min-width: 520px) { .grid { grid-template-columns: 1fr 1fr; } }

    label { font-size: .9rem; color: var(--muted); display: block; margin-bottom: 6px; }
    .field { display: flex; flex-direction: column; }

    input[type="text"], select { width: 100%; padding: 12px 12px; border: 1px solid #e5e7eb; border-radius: 10px; background: transparent; color: var(--text); }
    .choices__inner { border-radius: 10px; }
    /* Asegurar legibilidad también en modo claro */
    .choices__list--single .choices__item { color: var(--text); }
    .choices__list--dropdown .choices__item { color: var(--text); background: var(--panel); }

    /* Modo oscuro: mejorar legibilidad en Choices.js */
    [data-theme="dark"] .choices__inner {
      background: #0f172a;
      color: var(--text);
      border-color: #334155;
    }
    [data-theme="dark"] .choices__list--single .choices__item {
      color: var(--text) !important; /* texto de la moneda seleccionada */
    }
    [data-theme="dark"] .choices__list--single .choices__placeholder {
      color: var(--muted) !important;
      opacity: .9;
    }
    [data-theme="dark"] .choices__list--dropdown,
    [data-theme="dark"] .choices__list[aria-expanded] {
      background: #0f172a;
      border-color: #334155;
    }
    [data-theme="dark"] .choices__list--dropdown .choices__item {
      color: var(--text);
    }
    [data-theme="dark"] .choices__item--selectable.is-highlighted,
    [data-theme="dark"] .choices__list--dropdown .choices__item--selectable.is-highlighted {
      background-color: #1f2937;
      color: var(--text);
    }
    [data-theme="dark"] .choices__item--choice.is-selected {
      background-color: #111827;
      color: var(--text);
    }
    [data-theme="dark"] .choices__input { background: #0f172a; color: var(--text); }
    [data-theme="dark"] .choices__placeholder { color: var(--muted); opacity: .9; }
    [data-theme="dark"] .choices[data-type*="select-one"] .choices__button {
      filter: invert(1) hue-rotate(180deg);
    }
    [data-theme="dark"] ::selection { background: #3b82f6; color: #0f172a; }

    .flag { width: 20px; height: 14px; border-radius: 2px; vertical-align: middle; margin-right: 6px; }

    .swap-wrap { display: flex; align-items: center; justify-content: center; margin: 4px 0 8px; }
    .swap-btn { width: 42px; height: 42px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; }

    .status { min-height: 62px; margin-top: 8px; }
    .ok {
      background: var(--ok-bg); border: 1px solid var(--ok-border); border-radius: 10px; padding: 12px; font-size: .95rem;
    }
    .err {
      background: var(--err-bg); border: 1px solid var(--err-border); border-radius: 10px; padding: 12px; font-size: .95rem;
    }

    .history { margin-top: 14px; background: transparent; border-radius: 10px; border: 1px dashed #e5e7eb; padding: 10px; }
    .history h3 { margin: 0 0 8px; font-size: 1rem; }
    .history ul { list-style: none; padding: 0; margin: 0; display: grid; gap: 8px; }
    .history li { display: flex; align-items: center; gap: 6px; font-size: .95rem; color: var(--muted); }

    .footer { margin-top: 12px; font-size: .85rem; color: var(--muted); text-align: center; }
    .muted { color: var(--muted); }
  </style>
</head>
<body>
  <div class="card" id="app-card">
    <div class="card-header">
      <h1 class="title">Conversor de Monedas</h1>
      <div class="actions">
        <button id="toggle-theme" class="btn btn-outline" title="Cambiar tema">Tema</button>
      </div>
    </div>

    <div class="grid">
      <div class="field">
        <label for="moneda_origen">Convertir de</label>
        <select id="moneda_origen" name="moneda_origen" required>
          {% for m in monedas %}
          <option value="{{ m.codigo }}" data-custom-properties='<img src="{{ m.bandera }}" class="flag">' data-nombre="{{ m.nombre }}" data-bandera="{{ m.bandera }}" {% if m.codigo == 'EUR' %}selected{% endif %}>{{ m.nombre }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="field">
        <label for="moneda_destino">a</label>
        <select id="moneda_destino" name="moneda_destino" required>
          {% for m in monedas %}
          <option value="{{ m.codigo }}" data-custom-properties='<img src="{{ m.bandera }}" class="flag">' data-nombre="{{ m.nombre }}" data-bandera="{{ m.bandera }}" {% if m.codigo == 'USD' %}selected{% endif %}>{{ m.nombre }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="field" style="grid-column: 1 / -1;">
        <label for="cantidad">Cantidad</label>
        <input type="text" id="cantidad" name="cantidad" value="1" inputmode="decimal" autocomplete="off" placeholder="Ej. 150.75" />
      </div>
    </div>

    <div class="swap-wrap">
      <button id="invertir" type="button" class="btn swap-btn" title="Invertir monedas">&#8646;</button>
    </div>

    <div id="status" class="status"></div>

    {% if historial %}
    <div class="history">
      <h3>Historial reciente</h3>
      <ul>
        {% for h in historial %}
        <li>
          <img src="{{ h.bandera_origen }}" class="flag" alt=""> {{ h.cantidad }} {{ h.nombre_origen }}
          <span class="muted">→</span>
          <img src="{{ h.bandera_destino }}" class="flag" alt=""> {{ h.resultado }}
          <span class="muted" style="font-size:.85rem;">(Tasa: {{ h.tasa }})</span>
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <div class="footer">
      <span class="muted">Las tasas pueden variar. Los datos se obtienen de un servicio público y pueden tener retrasos.</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script>
    // Tema (claro/oscuro)
    (function initTheme(){
      const btn = document.getElementById('toggle-theme');
      const preferDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const saved = localStorage.getItem('theme');
      const current = saved || (preferDark ? 'dark' : 'light');
      document.body.setAttribute('data-theme', current);
      btn.addEventListener('click', () => {
        const next = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.body.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
      });
    })();

    // Choices.js para selects con banderas
    let ch1 = null, ch2 = null;
    try {
      ch1 = new Choices('#moneda_origen', { searchEnabled: true, itemSelectText: '', allowHTML: true, shouldSort: false });
      ch2 = new Choices('#moneda_destino', { searchEnabled: true, itemSelectText: '', allowHTML: true, shouldSort: false });
    } catch (e) {
      console.warn('Choices.js no se pudo inicializar, usando selects nativos', e);
    }

    // Obtener datos de la opción seleccionada (sin depender de variables JS)
    function getSelectedData(selectId){
      const sel = document.getElementById(selectId);
      const opt = sel.options[sel.selectedIndex];
      return {
        nombre: (opt && opt.dataset && opt.dataset.nombre) ? opt.dataset.nombre : sel.value,
        bandera: (opt && opt.dataset && opt.dataset.bandera) ? opt.dataset.bandera : ''
      };
    }

    // Invertir monedas
    document.getElementById('invertir').addEventListener('click', () => {
      const a = document.getElementById('moneda_origen').value;
      const b = document.getElementById('moneda_destino').value;
      if (ch1 && ch2) {
        ch1.setChoiceByValue(b);
        ch2.setChoiceByValue(a);
      } else {
        // Fallback: intercambiar valores en selects nativos
        const selA = document.getElementById('moneda_origen');
        const selB = document.getElementById('moneda_destino');
        const tmp = selA.value; selA.value = selB.value; selB.value = tmp;
      }
      triggerConvert();
    });

    // Debounce helper
    let tId;
    function debounce(fn, wait){
      clearTimeout(tId);
      tId = setTimeout(fn, wait);
    }

    // Validación simple de número
    function parseAmount(v){
      if (typeof v === 'string') v = v.replace(/,/g, '.').trim();
      const n = Number(v);
      return Number.isFinite(n) ? n : NaN;
    }

    // Convertir
    const status = document.getElementById('status');
    function renderError(msg){ status.innerHTML = `<div class="err">${msg}</div>`; }
    function renderOk(html){ status.innerHTML = `<div class="ok">${html}</div>`; }

    function convert(){
      const cantidadStr = document.getElementById('cantidad').value;
      const cantidad = parseAmount(cantidadStr);
      const origen = document.getElementById('moneda_origen').value;
      const destino = document.getElementById('moneda_destino').value;

      if (!Number.isFinite(cantidad) || cantidad <= 0){
        renderError('Por favor, introduce un número válido y mayor que cero.');
        return;
      }

      renderOk('Calculando…');

      fetch('/convertir', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cantidad, moneda_origen: origen, moneda_destino: destino })
      })
      .then(r => r.json())
      .then(data => {
        if (data.error){
          renderError(data.error);
          return;
        }
        const mo = getSelectedData('moneda_origen');
        const md = getSelectedData('moneda_destino');
        renderOk(`
          <strong>Resultado</strong><br>
          <img src="${mo.bandera}" class="flag" alt=""> ${data.cantidad} ${mo.nombre}
          <span class="muted">→</span>
          <img src="${md.bandera}" class="flag" alt=""> ${data.resultado}
          <div class="muted" style="margin-top:6px;">Tasa: ${data.tasa}</div>
        `);
      })
      .catch(() => {
        renderError('Ocurrió un error de red. Intenta de nuevo más tarde.');
      });
    }

    function triggerConvert(){ debounce(convert, 350); }

    document.getElementById('cantidad').addEventListener('input', triggerConvert);
    document.getElementById('moneda_origen').addEventListener('change', triggerConvert);
    document.getElementById('moneda_destino').addEventListener('change', triggerConvert);

    // Arranque
    triggerConvert();
  // Registrar service worker (PWA)
    if ('serviceWorker' in navigator){
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/static/sw.js').catch(()=>{});
      });
    }
  </script>
</body>
</html>
